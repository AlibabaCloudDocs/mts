# 创建工作流

工作流可以对上传的视频文件进行转码等媒体处理，并生成媒体文件，本文介绍了如何创建、管理工作流以及添加节点条件。

## 背景信息

您可以在工作流中设置**转码**、**智能审核**、**智能封面**、**视频DNA**、**截图**、**打包**、**分析**等节点条件，各节点可以自由组合，视频文件上传后自动触发工作流执行各节点条件，并生成媒体文件。使用工作流完整流程，请参见[快速使用工作流](/cn.zh-CN/快速入门/快速使用工作流.md)。如果仅需要进行单一的视频文件转码，请参见[创建转码任务](/cn.zh-CN/控制台指南/任务管理.md)。

## 前提条件

创建工作流前，请先[添加媒体Bucket](/cn.zh-CN/控制台指南/工作流管理/添加媒体Bucket.md)。

## 工作流节点功能简介

![节点](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3044242161/p238745.png)

|节点名称|节点说明|
|----|----|
|分析节点|对输入文件进行智能分析，推荐出适合输入文件的预置模板。|
|转码节点|可以将视频文件转码成适合在全平台播放的格式。|
|截图节点|截取指定时间点的画面，用做视频封面或生成雪碧图。|
|打包节点|将多字幕、多音轨、多码率视频流生成一个Master Playlist文件的过程。|
|审核节点|智能识别视频内语音、文字、画面的色情、暴恐涉政、不良画面等内容，大幅节省人工审核人力成本，降低违规风险。|
|视频DNA节点|用来唯一标记一个视频，实现对视频中的图像、音频等指纹特征的提取和比对，解决重复视频查找、视频片段查源、原创识别等问题。|
|智能封面节点|通过对视频内容的理解，结合画面和海量用户行为数据，基于算法选出最优的关键帧或关键片段作为视频封面，提升视频点击转化及用户体验。|

## 创建转码工作流

1.  登录[媒体处理控制台](https://mps.console.aliyun.com/executions/list)。
2.  在顶部菜单栏选择地域。

    ![地域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7340183161/p242178.png)

3.  在左侧导航栏，选择**工作流管理** \> **工作流设置**。
4.  单击**创建工作流**。
5.  设置工作流基础信息。

    ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9449704161/p242836.png)

    |参数|说明|
    |--|--|
    |**工作流名称**|在文本框中输入工作流名称。|
    |**配置方案**|在下拉列表中选择**自定义**。**说明：** 为满足通用场景需求，媒体处理提供了多种预置工作流，您也可以在**配置方案**下拉列表中选择一个预置工作流的进行快速编辑。预置工作流说明如下：

    -   **M3U8**：进行单张封面截图，并把视频转为M3U8格式。
    -   **预置智能模板工作流**：进行单张封面截图，并根据视频信息进行智能分析后转码，对转码后的标清视频截图。
    -   **多码率多格式工作流**：进行单张封面截图，并生成多种视频格式和码率视频。
    -   （**FVL**、**M3U8**、**MP4**）**多码率工作流**：进行单张封面截图，并生成多码率视频。
更多详情，请参见[预置模版详情](/cn.zh-CN/API参考/附录/预置模版详情.md)。 |

6.  设置节点。
    1.  设置**输入**。
        1.  单击**输入**节点右侧的笔形图标。进入**输入设置**页面。

            ![输入](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9449704161/p242837.png)

        2.  设置输入参数。

            ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9449704161/p242838.png)

            |参数|说明|
            |--|--|
            |**输入路径**|单击**选择**。在**Bucket**下拉列表中，选择Bucket名称。**路径**下方会显示对应Bucket已经创建好的文件夹，在文件夹下选择一个地址作为输入路径。 |
            |**转码管道**|在下拉列表中选择管道。|
            |（可选）**消息通知**|单击**开关按钮**，选择消息队列或消息主题，并设定队列或消息的实例。|

        3.  单击**确定**，完成**输入**设置。
    2.  添加**转码**节点。（根据业务需求，也可以添加其他节点，这里以转码节点为例）
        1.  单击**输入**节点右侧的加号图标，在下拉列表中选择**转码**节点。

            **说明：** 在**输入**节点、**审核**节点、**视频DNA**节点，单击加号图标，均可以添加**转码**节点。

            ![节点](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9449704161/p242839.png)

        2.  单击**转码**节点右侧的笔形图标，进入**基础配置**页面。

            ![节点](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9449704161/p242840.png)

        3.  设置转码。

            ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9449704161/p242842.png)

            |参数|说明|
            |--|--|
            |**名称**|在文本框中输入转码名称。|
            |**转码模板**|单击**选择**，在弹出窗中设置**转码模板**。            1.  选择**模板类型**。
            2.  选择**输出格式**、
            3.  选择**模板**。
            4.  单击**确定**。
**说明：** 创建自定义模板，请参见[转码模版](/cn.zh-CN/控制台指南/全局设置/转码模版.md)。预置模板说明，请参见[预置模版详情](/cn.zh-CN/API参考/附录/预置模版详情.md)。 |
            |**输出路径**|单击**选择**。在**Bucket**下拉列表中，选择Bucket名称。**路径**下方会显示对应Bucket已经创建好的文件夹，在文件夹下选择一个地址作为输出路径。

**说明：** **输出路径**是OSS存储执行工作流后，生成媒体文件的储存路径，输出Bucket不可与输入Bucket为同一个Bucket。

为避免媒体工作流多次执行时覆盖输出文件，您可以组合使用系统内置的UC变量参数：

            -   \{RunId\}：媒体工作流执行ID。
            -   \{ObjectPrefix\}：不含Bucket信息的原文件路径。
            -   \{FileName\}：不含扩展名的原文件名。
            -   \{ExtName\}：原文件扩展名。 |
            |（可选）**水印开关**|单击**开关按钮**。            1.  在**水印模板**下拉列表中选择模板名称。

**说明：** 如果下拉列表中没有水印模板，请创建[水印模板](/cn.zh-CN/控制台指南/全局设置/水印模板.md)。

            2.  在**水印图片**右侧单击**选择**添加水印图片路径。 |

        4.  单击**确定**，完成**转码**节点设置。
    3.  设置**发布**节点。
        1.  单击**发布**节点右侧笔形图标。

            ![发布](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0654234161/p242859.png)

        2.  设置发布。

            |参数|说明|
            |--|--|
            |**媒体发布类型**|选择**媒体发布类型**为**自动**。            -   **手动**发布：工作流执行成功后，将媒体设置为未发布状态，之后您可以手动发布该媒体。手动发布媒体文件，请参见[媒体列表](/cn.zh-CN/控制台指南/媒体管理/媒体列表.md)。
            -   **自动**发布：工作流执行成功后，将媒体设置为发布状态。

**说明：**

                -   发布含义：设置媒体所有播放资源、截图文件的访问权限继承所在Bucket的访问权限。
                -   不发布含义：媒体所有播放资源、截图文件的访问权限为私有。 |

        3.  单击**确定**，完成**发布**节点设置。
    4.  单击**保存**，完成工作流创建。

**说明：** 媒体工作流创建后，将自动激活为启用状态，上传至**输入**节点绑定的**输入路径**的音视频文件将会自动触发该工作流的执行。上传文件，请参见[OSS上传文件](/cn.zh-CN/控制台指南/媒体管理/上传视频.md)。

## 创建截图工作流

整体操作步骤与[创建转码工作流](#section_oz7_l44_0oi)一致，这里仅说明（6.设置节点）步骤中，添加节点步骤。

1.  添加**截图**节点。（在**输入**节点、**转码**节点、**审核**节点、**视频DNA**节点、**智能封面**节点，单击加号图标，均可以进行添加）。

    ![截图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242848.png)

2.  单击**截图**节点右侧笔形图标。

    ![图标](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6675355161/p249018.png)

3.  设置截图。

    设置截图方式，包括：单张截图、多张截图和平均截图。

    -   单张截图

        ![截图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9590915161/p246481.png)

        |参数|说明|
        |--|--|
        |**截图方式**|**单张截图**：设置一个明确的截图时间点，截取对应的视频图像。|
        |**名称**|在文本框中输入截图名称。|
        |**输出路径**|        1.  单击**选择**，进入**输出路径**设置页面。
        2.  在**Bucket**下拉列表中，选择Bucket名称。**路径**下方会显示对应Bucket已经创建好的文件夹，在文件夹下选择一个地址作为输出路径。 |
        |（非必填）**开始时间**|在下拉列表中按时、分、秒，选择时间。|
        |（非必填）**宽度×高度**|在输入框中分别填写宽度和高度值。**说明：**

        -   如果宽和高都不设置时，图片的尺寸和视频相同。
        -   如果只设置宽（或高）时，另一边会按照视频的分辨率保持比例不变，避免图像变形。 |
        |（可选）**设为封面**|单击**开关按钮**，此节点截取的图片会自动设置为媒体库中该媒体的封面，当有多张截图时，默认第一张设为封面。|
        |（可选）**关键帧**|单击**开关按钮**，截图类型如果为关键帧，则表示只截取关键帧，如对应指定时间点为非关键帧，则就近选取关键帧。|

    -   多张截图

        ![多张截图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6373975161/p249716.png)

        |参数|说明|
        |--|--|
        |**截图方式**|**多张截图**：按照设置的间隔时间，均匀的截取对应视频的多帧图像，每帧图像都是一个图片文件。也叫批量截图、序列截图。|
        |**截图间隔时间\(秒\)**|在文本框中输入截图间隔时间。|
        |**截图数量**|在文本框中输入截图数量。**说明：**

        -   不设置截图数量时，表示按照间隔时间，一直截取到视频结尾。
        -   截图数量大于1时，表示按照间隔时间，截取到指定数量的图像时就停止截图。
        -   设置截图时间等于1时，按照异步方式执行单帧截图。 |
        |**名称**|在文本框中输入截图名称。|
        |**输出路径**|        1.  单击**选择**，进入**输出路径**设置页面。
        2.  在**Bucket**下拉列表中，选择Bucket名称。**路径**下方会显示对应Bucket已经创建好的文件夹，在文件夹下选择一个地址作为输出路径。 |
        |（非必填）**开始时间**|在下拉列表中按时、分、秒，选择时间。|
        |（非必填）**宽度×高度**|在输入框中分别填写宽度和高度值。**说明：**

        -   如果宽和高都不设置时，图片的尺寸和视频相同。
        -   如果只设置宽（或高）时，另一边会按照视频的分辨率保持比例不变，避免图像变形。 |
        |（可选）**生成Webvtt索引文件**|单击**开关按钮**，表示需要使用webVTT格式的缩略图。|
        |（可选）**设为封面**|单击**开关按钮**，此节点截取的图片会自动设置为媒体库中该媒体的封面，当有多张截图时，默认第一张设为封面。|
        |（可选）**关键帧**|单击**开关按钮**，截图类型如果为关键帧，则表示只截取关键帧，如对应指定时间点为非关键帧，则就近选取关键帧。|
        |（可选）**黑屏检测**|单击**开关按钮**，会检测视频的前5秒，如果前5秒内存在画面，则截取第一帧非黑屏的画面。|

    -   平均截图

        ![平均截图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6373975161/p249718.png)

        |参数|说明|
        |--|--|
        |**截图方式**|**平均截图**：按照设定的截图张数，均匀地对视频进行切分并截取指定数量的图像。|
        |**截图数量**|在文本框中输入截图数量。|
        |**名称**|在文本框中输入截图名称。|
        |**输出路径**|        1.  单击**选择**，进入**输出路径**设置页面。
        2.  在**Bucket**下拉列表中，选择Bucket名称。**路径**下方会显示对应Bucket已经创建好的文件夹，在文件夹下选择一个地址作为输出路径。 |
        |（非必填）**开始时间**|在下拉列表中按时、分、秒，选择时间。|
        |（非必填）**宽度×高度**|在输入框中分别填写宽度和高度值。**说明：**

        -   如果宽和高都不设置时，图片的尺寸和视频相同。
        -   如果只设置宽（或高）时，另一边会按照视频的分辨率保持比例不变，避免图像变形。 |
        |（可选）**生成Webvtt索引文件**|单击**开关按钮**，表示需要使用webVTT格式的缩略图。|
        |（可选）**设为封面**|单击**开关按钮**，此节点截取的图片会自动设置为媒体库中该媒体的封面，当有多张截图时，默认第一张设为封面。|
        |（可选）**关键帧**|单击**开关按钮**，截图类型如果为关键帧，则表示只截取关键帧，如对应指定时间点为非关键帧，则就近选取关键帧。|
        |（可选）**黑屏检测**|单击**开关按钮**，会检测视频的前5秒，如果前5秒内存在画面，则截取第一帧非黑屏的画面。|

4.  单击**确定**，完成**截图**节点设置。

## 创建打包工作流

整体操作步骤与[创建转码工作流](#section_oz7_l44_0oi)一致，这里仅说明（6.设置节点）步骤中，添加节点步骤。

1.  添加**打包**节点。（在**输入**节点单击加号图标进行添加）。

    ![打包](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242792.png)

2.  设置打包。

    打包节点分为以下3个子节点：

    ![节点](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242793.png)

    1.  单击**打包配置**节点笔形图标。
        1.  设置打包配置。

            ![配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0184355161/p249032.png)

            在**输出路径**右侧，单击**选择**，选择OSS输出地址。

        2.  单击**确定**，完成打包配置设置。
    2.  单击**视频提取**节点笔形图标。
        1.  设置视频提取。

            ![提取](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9590915161/p246478.png)

            |参数|说明|
            |--|--|
            |**转码模板**|单击**选择**，选择转码模板。预置转码模板说明，请参见[预置模版详情](/cn.zh-CN/API参考/附录/预置模版详情.md)。设置自定义转码模板，请参见[转码模版](/cn.zh-CN/控制台指南/全局设置/转码模版.md)。|
            |（可选）**水印开关**|单击**开关按钮**。            1.  在**水印模板**下拉列表中选择模板名称。创建水印模板，请参见[水印模板](/cn.zh-CN/控制台指南/全局设置/水印模板.md)
            2.  在**水印图片**右侧单击**选择**添加水印图片路径。 |

        2.  单击**确定**，完成视频提取设置。
    3.  单击**打包生成**节点笔形图标。
        1.  设置打包生成。

            ![宽带](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242813.png)

            |参数|说明|
            |--|--|
            |**网络宽带**|在文本框中输入宽带值。|
            |**音频组**|默认必选项。|
            |**字幕组**|默认必选项。|

        2.  单击**确定**，完成**打包**节点设置。

## 创建审核工作流

**说明：** 审核节点功能，目前开通的区域为华北2（北京）、华东2（上海）、新加坡，后续会陆续开放其他区域。

整体操作步骤与[创建转码工作流](#section_oz7_l44_0oi)一致，这里仅说明（6.设置节点）步骤中，添加节点步骤。

1.  添加**审核**节点。（在**输入**节点、**转码**节点，单击加号图标，均可以进行添加）。

    ![节点](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242824.png)

2.  单击**审核**节点笔形图标。

    ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0184355161/p249051.png)

3.  设置审核。

    ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242826.png)

    |参数|说明|
    |--|--|
    |**审核管道**|在下拉列表中选择管道。**说明：** 如果**审核管道**下拉列表中没有管道名称，请先开启审核专用管道。具体操作，请参见[开启管道](/cn.zh-CN/控制台指南/全局设置/管道/开启管道.md)。 |
    |**输出路径**|单击**选择**，选择OSS输出地址。|
    |**是否终止工作流**|在选项中，根据实际需求进行选择。|

4.  单击**确定**，完成**审核**节点设置。

## 创建视频DNA工作流

**说明：** 视频DNA节点功能，目前开通的区域为华北2（北京）、华东1（杭州）、华东2（上海）、新加坡，后续会陆续开放其他区域。

整体操作步骤与[创建转码工作流](#section_oz7_l44_0oi)一致，这里仅说明（6.设置节点）步骤中，添加节点步骤。

1.  添加**视频DNA**节点。（在**输入**节点、**转码**节点，单击加号图标，均可以进行添加）。

    ![DNA](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242829.png)

2.  单击**视频DNA**笔形图标。

    ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1184355161/p249053.png)

3.  设置视频DNA。

    ![设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242830.png)

    |参数|说明|
    |--|--|
    |**视频DNA管道**|在下拉列表中选择管道。**说明：** 如果**视频DNA管道**下拉列表中没有管道名称，请先开启视频DNA专用管道。具体操作，请参见[开启管道](/cn.zh-CN/控制台指南/全局设置/管道/开启管道.md)。 |
    |**入库规则**|    -   **仅入库不重复内容**：表示DNA库中只保存不重复的视频的DNA，重复视频将不会对其DNA进行入库操作。
    -   **所有视频均不入库**：表示对视频只做比对并不需要保留视频DNA。 |
    |（可选）**版权保护**|单击**开关按钮**。**说明：** 开启后，将通过蚂蚁金服版权区块链对DNA进行存证，存证结果可由司法机关进行核验。 |
    |**是否终止工作流**|在选项中，根据实际需求进行选择。|

4.  单击**确定**，完成**视频DNA**节点设置。

## 创建智能封面工作流

**说明：** 智能封面节点功能，目前开通的区域为华北2（北京）、华东2（上海），后续会陆续开放其他区域。

整体操作步骤与[创建转码工作流](#section_oz7_l44_0oi)一致，这里仅说明（6.设置节点）步骤中，添加节点步骤。

1.  添加**智能封面**节点，（在**输入**节点、**转码**节点，单击加号图标，均可以进行添加）。

    ![封面](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242831.png)

2.  单击**智能封面**笔形图标。

    ![智能](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1184355161/p249104.png)

3.  设置智能封面。

    ![封面](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1549704161/p242834.png)

    |参数|说明|
    |--|--|
    |**名称**|在文本输入框中输入封面名称。|
    |**智能封面管道**|在下拉列表中选择管道。**说明：** 如果**智能封面管道**下拉列表中没有管道名称，请先开启智能封面专用管道。具体操作，请参见[开启管道](/cn.zh-CN/控制台指南/全局设置/管道/开启管道.md)。 |
    |**输出路径**|单击**选择**，选择OSS输出地址。|
    |（可选）**设置封面**|单击**开关按钮**，将图片设为封面。|

4.  单击**确定**，完成**智能封面**节点设置。

## 创建分析工作流

整体操作步骤与[创建转码工作流](#section_oz7_l44_0oi)一致，这里仅说明（6.设置节点）步骤中，添加节点步骤。

1.  添加**分析**节点，（在**输入**节点单击加号图标进行添加）。

    ![分析](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242775.png)

2.  单击**分析**节点笔形图标。

    ![笔形](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0549704161/p242779.png)

3.  设置分析。

    ![分析](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1184355161/p249100.png)

    在**条件转码**下拉列表中选择清晰度。

4.  单击**确定**，完成**分析**节点设置。

## 编辑、删除工作流

如需对媒体工作流进行编辑修改或删除，在工作流**操作**列，单击**停用**，将工作流设置为停用状态。

完成编辑后，在工作流**操作**列，单击**启用**，以恢复工作流的自动处理机制。

**说明：** 工作流停用后，自动执行机制将会停止工作，当前处于正在执行状态的工作流实例会继续执行，直到完成实例执行。

